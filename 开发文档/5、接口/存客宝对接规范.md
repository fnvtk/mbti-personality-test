# ğŸ”— å­˜å®¢å®æ¥å£å¯¹æ¥è§„èŒƒ (CunKeBao API Standard)

> **ç”¨é€”**: æ‰€æœ‰é¡¹ç›®å¯¹æ¥å­˜å®¢å®ç³»ç»Ÿçš„ç»Ÿä¸€è§„èŒƒ
> **ç‰ˆæœ¬**: v1.0
> **é€‚ç”¨åœºæ™¯**: çº¿ç´¢ä¸ŠæŠ¥ã€ç”¨æˆ·ç”»åƒã€æµé‡æ± ç®¡ç†

---

## ğŸ“‹ ä¸€ã€å¿«é€Ÿå¯¹æ¥æŒ‡å—

### 1.1 å¯¹æ¥å‰å‡†å¤‡
```yaml
å¿…é¡»è·å–:
  - apiKey: å­˜å®¢å®åˆ†é…çš„æ¥å£å¯†é’¥ï¼ˆæ¯ä¸ªä»»åŠ¡/åœºæ™¯å”¯ä¸€ï¼‰
  
æ¥å£åœ°å€:
  - ç”Ÿäº§ç¯å¢ƒ: https://ckbapi.quwanzhi.com/v1/api/scenarios
  - æµ‹è¯•ç¯å¢ƒ: [æŒ‰éœ€é…ç½®]
  
è¯·æ±‚æ ¼å¼:
  - Content-Type: application/json (æ¨è)
  - å¤‡é€‰: application/x-www-form-urlencoded
  - ç¼–ç : UTF-8
```

### 1.2 ä¸€åˆ†é’Ÿæ¥å…¥
```javascript
// æœ€ç®€è°ƒç”¨ç¤ºä¾‹
const response = await fetch('https://ckbapi.quwanzhi.com/v1/api/scenarios', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    apiKey: 'YOUR_API_KEY',
    timestamp: Math.floor(Date.now() / 1000),
    phone: '13800000000',
    sign: generateSign(params)  // è§ç­¾åç®—æ³•
  })
});
```

---

## ğŸ” äºŒã€ç­¾åç®—æ³•ï¼ˆæ ¸å¿ƒï¼‰

### 2.1 ç­¾åç”Ÿæˆæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç­¾åç”Ÿæˆæµç¨‹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 1: å‡†å¤‡å‚æ•°                                                   â”‚
â”‚  â””â”€â”€ æ”¶é›†æ‰€æœ‰è¯·æ±‚å‚æ•°ï¼ˆå« apiKey, timestamp, ä¸šåŠ¡å‚æ•°ï¼‰              â”‚
â”‚                                                                      â”‚
â”‚  Step 2: ç§»é™¤ç‰¹æ®Šå­—æ®µ                                               â”‚
â”‚  â””â”€â”€ ç§»é™¤: sign, apiKey, portrait                                   â”‚
â”‚                                                                      â”‚
â”‚  Step 3: ç§»é™¤ç©ºå€¼                                                   â”‚
â”‚  â””â”€â”€ ç§»é™¤: null, ''ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰                                     â”‚
â”‚                                                                      â”‚
â”‚  Step 4: æŒ‰é”®åæ’åº                                                 â”‚
â”‚  â””â”€â”€ ASCII å‡åºæ’åºï¼ˆaâ†’zï¼‰                                          â”‚
â”‚                                                                      â”‚
â”‚  Step 5: æ‹¼æ¥å‚æ•°å€¼                                                 â”‚
â”‚  â””â”€â”€ åªå–å€¼ï¼Œé¡ºåºæ‹¼æ¥ï¼Œæ— åˆ†éš”ç¬¦                                     â”‚
â”‚                                                                      â”‚
â”‚  Step 6: ç¬¬ä¸€æ¬¡ MD5                                                 â”‚
â”‚  â””â”€â”€ firstMd5 = MD5(æ‹¼æ¥å­—ç¬¦ä¸²)                                     â”‚
â”‚                                                                      â”‚
â”‚  Step 7: ç¬¬äºŒæ¬¡ MD5                                                 â”‚
â”‚  â””â”€â”€ sign = MD5(firstMd5 + apiKey)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç­¾åè§„åˆ™è¯¦è§£

```yaml
# ç­¾åè§„åˆ™
ä¸å‚ä¸ç­¾åçš„å­—æ®µ:
  - sign: ç­¾åæœ¬èº«ä¸å‚ä¸
  - apiKey: ä¸å‚ä¸æ‹¼æ¥ï¼Œåªåœ¨æœ€åä¸€æ­¥å‚ä¸äºŒæ¬¡MD5
  - portrait: æ•´ä¸ªç”»åƒå¯¹è±¡ä¸å‚ä¸ï¼ˆé¿å…å¤æ‚åº¦ï¼‰

ç©ºå€¼å¤„ç†:
  - null å€¼å­—æ®µ: ä¸å‚ä¸ç­¾å
  - ç©ºå­—ç¬¦ä¸² '': ä¸å‚ä¸ç­¾å

æ’åºè§„åˆ™:
  - æŒ‰å‚æ•°åï¼ˆé”®åï¼‰ASCII å‡åº
  - ä¾‹å¦‚: name, phone, source, timestamp

æ‹¼æ¥è§„åˆ™:
  - åªå–å€¼ï¼Œä¸å–é”®
  - é¡ºåºç›´æ¥æ‹¼æ¥ï¼Œæ— åˆ†éš”ç¬¦
  - ä¾‹å¦‚: "å¼ ä¸‰13800000000å¾®ä¿¡å¹¿å‘Š1710000000"

MD5 è§„åˆ™:
  - ä½¿ç”¨å°å†™ MD5
  - ä¸¤æ¬¡ MD5: å…ˆå¯¹æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œå†å¯¹ç»“æœ+apiKey
```

### 2.3 ç­¾åä»£ç å®ç°

#### TypeScript/JavaScript å®ç°
```typescript
/**
 * å­˜å®¢å®ç­¾åç”Ÿæˆå™¨
 * @description ç”Ÿæˆç¬¦åˆå­˜å®¢å®æ¥å£è§„èŒƒçš„ç­¾å
 * @param params è¯·æ±‚å‚æ•°ï¼ˆä¸å«signï¼‰
 * @param apiKey æ¥å£å¯†é’¥
 * @returns ç­¾åå­—ç¬¦ä¸²ï¼ˆå°å†™MD5ï¼‰
 */
function generateCKBSign(params: Record<string, any>, apiKey: string): string {
  // Step 1: å¤åˆ¶å‚æ•°ï¼Œç§»é™¤ç‰¹æ®Šå­—æ®µ
  const signParams = { ...params };
  delete signParams.sign;
  delete signParams.apiKey;
  delete signParams.portrait;
  
  // Step 2: ç§»é™¤ç©ºå€¼
  Object.keys(signParams).forEach(key => {
    if (signParams[key] === null || signParams[key] === '') {
      delete signParams[key];
    }
  });
  
  // Step 3: æŒ‰é”®åæ’åº
  const sortedKeys = Object.keys(signParams).sort();
  
  // Step 4: æ‹¼æ¥å‚æ•°å€¼
  const stringToSign = sortedKeys.map(key => signParams[key]).join('');
  
  // Step 5: ç¬¬ä¸€æ¬¡ MD5
  const firstMd5 = md5(stringToSign);
  
  // Step 6: ç¬¬äºŒæ¬¡ MD5ï¼ˆæ‹¼æ¥ apiKeyï¼‰
  const sign = md5(firstMd5 + apiKey);
  
  return sign;
}

// ä½¿ç”¨ç¤ºä¾‹
const params = {
  apiKey: 'YOUR_API_KEY',
  timestamp: Math.floor(Date.now() / 1000),
  phone: '13800000000',
  name: 'å¼ ä¸‰',
  source: 'å¾®ä¿¡å¹¿å‘Š'
};

const sign = generateCKBSign(params, params.apiKey);
params.sign = sign;
```

#### Python å®ç°
```python
"""
å­˜å®¢å®ç­¾åç”Ÿæˆå™¨
"""
import hashlib
from typing import Dict, Any

def generate_ckb_sign(params: Dict[str, Any], api_key: str) -> str:
    """
    ç”Ÿæˆå­˜å®¢å®æ¥å£ç­¾å
    
    Args:
        params: è¯·æ±‚å‚æ•°ï¼ˆä¸å«signï¼‰
        api_key: æ¥å£å¯†é’¥
        
    Returns:
        ç­¾åå­—ç¬¦ä¸²ï¼ˆå°å†™MD5ï¼‰
    """
    # Step 1: å¤åˆ¶å‚æ•°ï¼Œç§»é™¤ç‰¹æ®Šå­—æ®µ
    sign_params = {k: v for k, v in params.items() 
                   if k not in ['sign', 'apiKey', 'portrait']}
    
    # Step 2: ç§»é™¤ç©ºå€¼
    sign_params = {k: v for k, v in sign_params.items() 
                   if v is not None and v != ''}
    
    # Step 3: æŒ‰é”®åæ’åº
    sorted_keys = sorted(sign_params.keys())
    
    # Step 4: æ‹¼æ¥å‚æ•°å€¼
    string_to_sign = ''.join(str(sign_params[k]) for k in sorted_keys)
    
    # Step 5: ç¬¬ä¸€æ¬¡ MD5
    first_md5 = hashlib.md5(string_to_sign.encode('utf-8')).hexdigest()
    
    # Step 6: ç¬¬äºŒæ¬¡ MD5
    sign = hashlib.md5((first_md5 + api_key).encode('utf-8')).hexdigest()
    
    return sign


# ä½¿ç”¨ç¤ºä¾‹
import time

params = {
    'apiKey': 'YOUR_API_KEY',
    'timestamp': int(time.time()),
    'phone': '13800000000',
    'name': 'å¼ ä¸‰',
    'source': 'å¾®ä¿¡å¹¿å‘Š'
}

sign = generate_ckb_sign(params, params['apiKey'])
params['sign'] = sign
```

#### PHP å®ç°
```php
<?php
/**
 * å­˜å®¢å®ç­¾åç”Ÿæˆå™¨
 * 
 * @param array $params è¯·æ±‚å‚æ•°ï¼ˆä¸å«signï¼‰
 * @param string $apiKey æ¥å£å¯†é’¥
 * @return string ç­¾åå­—ç¬¦ä¸²ï¼ˆå°å†™MD5ï¼‰
 */
function generateCKBSign(array $params, string $apiKey): string {
    // Step 1: ç§»é™¤ç‰¹æ®Šå­—æ®µ
    unset($params['sign'], $params['apiKey'], $params['portrait']);
    
    // Step 2: ç§»é™¤ç©ºå€¼
    $params = array_filter($params, function($value) {
        return !is_null($value) && $value !== '';
    });
    
    // Step 3: æŒ‰é”®åæ’åº
    ksort($params);
    
    // Step 4: æ‹¼æ¥å‚æ•°å€¼
    $stringToSign = implode('', array_values($params));
    
    // Step 5: ç¬¬ä¸€æ¬¡ MD5
    $firstMd5 = md5($stringToSign);
    
    // Step 6: ç¬¬äºŒæ¬¡ MD5
    $sign = md5($firstMd5 . $apiKey);
    
    return $sign;
}

// ä½¿ç”¨ç¤ºä¾‹
$params = [
    'apiKey' => 'YOUR_API_KEY',
    'timestamp' => time(),
    'phone' => '13800000000',
    'name' => 'å¼ ä¸‰',
    'source' => 'å¾®ä¿¡å¹¿å‘Š'
];

$sign = generateCKBSign($params, $params['apiKey']);
$params['sign'] = $sign;
```

---

## ğŸ“¤ ä¸‰ã€è¯·æ±‚å‚æ•°è§„èŒƒ

### 3.1 é‰´æƒå­—æ®µï¼ˆå¿…å¡«ï¼‰

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|:---|:---|:---:|:---|
| `apiKey` | string | âœ… | å­˜å®¢å®åˆ†é…çš„æ¥å£å¯†é’¥ |
| `sign` | string | âœ… | ç­¾åå€¼ï¼ˆè§ç­¾åç®—æ³•ï¼‰ |
| `timestamp` | int | âœ… | ç§’çº§æ—¶é—´æˆ³ï¼Œä¸æœåŠ¡å™¨æ—¶é—´å·® â‰¤ 5åˆ†é’Ÿ |

### 3.2 ä¸»æ ‡è¯†å­—æ®µï¼ˆè‡³å°‘ä¼ ä¸€ä¸ªï¼‰

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|:---|:---|:---:|:---|
| `wechatId` | string | äºŒé€‰ä¸€ | å¾®ä¿¡å·ï¼Œä¼˜å…ˆä½œä¸ºä¸»æ ‡è¯† |
| `phone` | string | äºŒé€‰ä¸€ | æ‰‹æœºå·ï¼ŒwechatId ä¸ºç©ºæ—¶ç”¨ä½œä¸»æ ‡è¯† |

### 3.3 åŸºç¡€ä¿¡æ¯å­—æ®µï¼ˆå¯é€‰ï¼‰

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|:---|:---|:---:|:---|:---|
| `name` | string | âŒ | å®¢æˆ·å§“å | "å¼ ä¸‰" |
| `source` | string | âŒ | çº¿ç´¢æ¥æº | "æŠ–éŸ³ç›´æ’­é—´" |
| `remark` | string | âŒ | å¤‡æ³¨ä¿¡æ¯ | "é€šè¿‡H5è½åœ°é¡µç•™èµ„" |
| `tags` | string | âŒ | å¾®ä¿¡æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰ | "é«˜æ„å‘,ç”µå•†,å¥³è£…" |
| `siteTags` | string | âŒ | ç«™å†…æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰ | "æ–°å®¢,VIP" |

### 3.4 ç”¨æˆ·ç”»åƒå­—æ®µï¼ˆå¯é€‰ï¼‰

```typescript
interface Portrait {
  /** 
   * ç”»åƒç±»å‹
   * 0-æµè§ˆ 1-ç‚¹å‡» 2-ä¸‹å•/è´­ä¹° 3-æ³¨å†Œ 4-äº’åŠ¨
   */
  type?: 0 | 1 | 2 | 3 | 4;
  
  /**
   * ç”»åƒæ¥æº
   * 0-æœ¬ç«™ 1-è€æ²¹æ¡ 2-è€å‘çˆ¹
   */
  source?: 0 | 1 | 2;
  
  /**
   * ç”»åƒæ˜ç»†æ•°æ®ï¼ˆä»»æ„é”®å€¼å¯¹ï¼‰
   */
  sourceData?: {
    age?: number;
    gender?: string;
    city?: string;
    productId?: string;
    pageUrl?: string;
    [key: string]: any;
  };
  
  /**
   * ç”»åƒå¤‡æ³¨ï¼Œæœ€å¤§100å­—ç¬¦
   */
  remark?: string;
  
  /**
   * å»é‡å”¯ä¸€ID
   * ç›¸åŒ uniqueId åœ¨åŠå°æ—¶å†…ä¼šåˆå¹¶ç»Ÿè®¡
   * å»ºè®®æ ¼å¼: {æ¥æº}_{ç”¨æˆ·æ ‡è¯†}_{æ—¶é—´æˆ³}_{åºå·}
   */
  uniqueId?: string;
}
```

#### ç”»åƒç±»å‹è¯´æ˜

| å€¼ | ç±»å‹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|:---:|:---|:---|:---|
| 0 | æµè§ˆ | ç”¨æˆ·æµè§ˆäº†é¡µé¢æˆ–å†…å®¹ | é¡µé¢è®¿é—®ã€å•†å“æµè§ˆ |
| 1 | ç‚¹å‡» | ç”¨æˆ·ç‚¹å‡»äº†æŸä¸ªå…ƒç´  | æŒ‰é’®ç‚¹å‡»ã€å¹¿å‘Šç‚¹å‡» |
| 2 | ä¸‹å•/è´­ä¹° | ç”¨æˆ·å®Œæˆäº†è´­ä¹°è¡Œä¸º | è®¢å•æäº¤ã€æ”¯ä»˜å®Œæˆ |
| 3 | æ³¨å†Œ | ç”¨æˆ·å®Œæˆäº†æ³¨å†Œ | è´¦å·æ³¨å†Œã€ä¼šå‘˜æ³¨å†Œ |
| 4 | äº’åŠ¨ | ç”¨æˆ·è¿›è¡Œäº†äº’åŠ¨è¡Œä¸º | ç‚¹èµã€è¯„è®ºã€åˆ†äº« |

---

## ğŸ“¥ å››ã€å“åº”æ ¼å¼è§„èŒƒ

### 4.1 ç»Ÿä¸€å“åº”ç»“æ„

```typescript
interface CKBResponse<T = any> {
  code: number;      // 200=æˆåŠŸï¼Œå…¶ä»–=å¤±è´¥
  message: string;   // æç¤ºä¿¡æ¯
  data: T | null;    // ä¸šåŠ¡æ•°æ®
}
```

### 4.2 æˆåŠŸå“åº”

```json
// æ–°å¢æˆåŠŸ
{ "code": 200, "message": "æ–°å¢æˆåŠŸ", "data": "13800000000" }

// å·²å­˜åœ¨
{ "code": 200, "message": "å·²å­˜åœ¨", "data": "13800000000" }
```

### 4.3 é”™è¯¯å“åº”

| code | message | è¯´æ˜ | å¤„ç†å»ºè®® |
|:---:|:---|:---|:---|
| 400 | apiKeyä¸èƒ½ä¸ºç©º | ç¼ºå°‘ apiKey | æ£€æŸ¥å‚æ•° |
| 400 | signä¸èƒ½ä¸ºç©º | ç¼ºå°‘ç­¾å | æ£€æŸ¥ç­¾åç”Ÿæˆ |
| 400 | timestampä¸èƒ½ä¸ºç©º | ç¼ºå°‘æ—¶é—´æˆ³ | æ·»åŠ æ—¶é—´æˆ³ |
| 400 | è¯·æ±‚å·²è¿‡æœŸ | æ—¶é—´æˆ³è¶…è¿‡5åˆ†é’Ÿ | åŒæ­¥æœåŠ¡å™¨æ—¶é—´ |
| 401 | æ— æ•ˆçš„apiKey | apiKey é”™è¯¯ | æ£€æŸ¥ apiKey |
| 401 | ç­¾åéªŒè¯å¤±è´¥ | ç­¾åé”™è¯¯ | æ£€æŸ¥ç­¾åç®—æ³• |
| 500 | ç³»ç»Ÿé”™è¯¯ | æœåŠ¡ç«¯å¼‚å¸¸ | è”ç³»æŠ€æœ¯æ”¯æŒ |

---

## ğŸ“ äº”ã€å®Œæ•´è¯·æ±‚ç¤ºä¾‹

### 5.1 åŸºç¡€çº¿ç´¢ä¸ŠæŠ¥

```json
{
  "apiKey": "YOUR_API_KEY",
  "timestamp": 1710000000,
  "phone": "13800000000",
  "name": "å¼ ä¸‰",
  "source": "å¾®ä¿¡å¹¿å‘Š",
  "remark": "é€šè¿‡H5è½åœ°é¡µç•™èµ„",
  "tags": "é«˜æ„å‘,ç”µå•†",
  "sign": "a1b2c3d4e5f6..."
}
```

### 5.2 å¸¦å¾®ä¿¡å·çš„çº¿ç´¢ä¸ŠæŠ¥

```json
{
  "apiKey": "YOUR_API_KEY",
  "timestamp": 1710000000,
  "wechatId": "wxid_abcdefg123",
  "phone": "13800000001",
  "name": "æå››",
  "source": "å°ç¨‹åºè½åœ°é¡µ",
  "tags": "ä¸­æ„å‘,ç›´æ’­",
  "sign": "a1b2c3d4e5f6..."
}
```

### 5.3 å¸¦ç”¨æˆ·ç”»åƒçš„çº¿ç´¢ä¸ŠæŠ¥

```json
{
  "apiKey": "YOUR_API_KEY",
  "timestamp": 1710000000,
  "phone": "13800000002",
  "name": "ç‹äº”",
  "source": "ç™¾åº¦æ¨å¹¿",
  "portrait": {
    "type": 1,
    "source": 0,
    "sourceData": {
      "age": 28,
      "gender": "female",
      "city": "ä¸Šæµ·",
      "productId": "P12345",
      "pageUrl": "https://example.com/product/123"
    },
    "remark": "ç‚¹å‡»äº†ç«‹å³å’¨è¯¢æŒ‰é’®",
    "uniqueId": "site_13800000002_1710000000_001"
  },
  "sign": "a1b2c3d4e5f6..."
}
```

---

## ğŸ› ï¸ å…­ã€å°è£…å·¥å…·ç±»

### 6.1 TypeScript å®Œæ•´å°è£…

```typescript
/**
 * å­˜å®¢å® API å®¢æˆ·ç«¯
 * @description å°è£…å­˜å®¢å®æ¥å£è°ƒç”¨ï¼Œè‡ªåŠ¨å¤„ç†ç­¾å
 */
import crypto from 'crypto';

interface CKBConfig {
  apiKey: string;
  baseUrl?: string;
}

interface LeadData {
  phone?: string;
  wechatId?: string;
  name?: string;
  source?: string;
  remark?: string;
  tags?: string;
  siteTags?: string;
  portrait?: {
    type?: 0 | 1 | 2 | 3 | 4;
    source?: 0 | 1 | 2;
    sourceData?: Record<string, any>;
    remark?: string;
    uniqueId?: string;
  };
}

interface CKBResponse<T = any> {
  code: number;
  message: string;
  data: T;
}

export class CunKeBaoClient {
  private apiKey: string;
  private baseUrl: string;

  constructor(config: CKBConfig) {
    this.apiKey = config.apiKey;
    this.baseUrl = config.baseUrl || 'https://ckbapi.quwanzhi.com';
  }

  /**
   * ç”Ÿæˆ MD5
   */
  private md5(str: string): string {
    return crypto.createHash('md5').update(str, 'utf8').digest('hex');
  }

  /**
   * ç”Ÿæˆç­¾å
   */
  private generateSign(params: Record<string, any>): string {
    // å¤åˆ¶å‚æ•°ï¼Œç§»é™¤ç‰¹æ®Šå­—æ®µ
    const signParams = { ...params };
    delete signParams.sign;
    delete signParams.apiKey;
    delete signParams.portrait;

    // ç§»é™¤ç©ºå€¼
    Object.keys(signParams).forEach(key => {
      if (signParams[key] === null || signParams[key] === '') {
        delete signParams[key];
      }
    });

    // æŒ‰é”®åæ’åº
    const sortedKeys = Object.keys(signParams).sort();

    // æ‹¼æ¥å‚æ•°å€¼
    const stringToSign = sortedKeys.map(key => signParams[key]).join('');

    // ä¸¤æ¬¡ MD5
    const firstMd5 = this.md5(stringToSign);
    return this.md5(firstMd5 + this.apiKey);
  }

  /**
   * ä¸ŠæŠ¥çº¿ç´¢
   * @param data çº¿ç´¢æ•°æ®
   */
  async reportLead(data: LeadData): Promise<CKBResponse<string>> {
    const timestamp = Math.floor(Date.now() / 1000);
    
    const params: Record<string, any> = {
      apiKey: this.apiKey,
      timestamp,
      ...data,
    };

    // ç”Ÿæˆç­¾å
    params.sign = this.generateSign(params);

    // å‘é€è¯·æ±‚
    const response = await fetch(`${this.baseUrl}/v1/api/scenarios`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(params),
    });

    return response.json();
  }

  /**
   * ä¸ŠæŠ¥ç”¨æˆ·ç”»åƒ
   * @param identifier ç”¨æˆ·æ ‡è¯†ï¼ˆphone æˆ– wechatIdï¼‰
   * @param portrait ç”»åƒæ•°æ®
   */
  async reportPortrait(
    identifier: { phone?: string; wechatId?: string },
    portrait: LeadData['portrait']
  ): Promise<CKBResponse<string>> {
    return this.reportLead({
      ...identifier,
      portrait,
    });
  }
}

// ============ ä½¿ç”¨ç¤ºä¾‹ ============

// åˆå§‹åŒ–å®¢æˆ·ç«¯
const ckb = new CunKeBaoClient({
  apiKey: 'YOUR_API_KEY',
});

// ä¸ŠæŠ¥çº¿ç´¢
await ckb.reportLead({
  phone: '13800000000',
  name: 'å¼ ä¸‰',
  source: 'å¾®ä¿¡å¹¿å‘Š',
  tags: 'é«˜æ„å‘,ç”µå•†',
});

// ä¸ŠæŠ¥å¸¦ç”»åƒçš„çº¿ç´¢
await ckb.reportLead({
  phone: '13800000001',
  name: 'æå››',
  source: 'æŠ–éŸ³ç›´æ’­',
  portrait: {
    type: 1,  // ç‚¹å‡»
    sourceData: {
      productId: 'P12345',
      pageUrl: 'https://example.com/product',
    },
    uniqueId: 'site_13800000001_' + Date.now(),
  },
});
```

### 6.2 Python å®Œæ•´å°è£…

```python
"""
å­˜å®¢å® API å®¢æˆ·ç«¯
å°è£…å­˜å®¢å®æ¥å£è°ƒç”¨ï¼Œè‡ªåŠ¨å¤„ç†ç­¾å
"""
import hashlib
import time
import requests
from typing import Optional, Dict, Any
from dataclasses import dataclass, asdict

@dataclass
class Portrait:
    """ç”¨æˆ·ç”»åƒ"""
    type: int = 0  # 0-æµè§ˆ 1-ç‚¹å‡» 2-ä¸‹å• 3-æ³¨å†Œ 4-äº’åŠ¨
    source: int = 0  # 0-æœ¬ç«™ 1-è€æ²¹æ¡ 2-è€å‘çˆ¹
    sourceData: Optional[Dict[str, Any]] = None
    remark: Optional[str] = None
    uniqueId: Optional[str] = None


class CunKeBaoClient:
    """å­˜å®¢å® API å®¢æˆ·ç«¯"""
    
    def __init__(self, api_key: str, base_url: str = "https://ckbapi.quwanzhi.com"):
        self.api_key = api_key
        self.base_url = base_url
    
    def _md5(self, s: str) -> str:
        """ç”Ÿæˆ MD5"""
        return hashlib.md5(s.encode('utf-8')).hexdigest()
    
    def _generate_sign(self, params: Dict[str, Any]) -> str:
        """ç”Ÿæˆç­¾å"""
        # å¤åˆ¶å‚æ•°ï¼Œç§»é™¤ç‰¹æ®Šå­—æ®µ
        sign_params = {k: v for k, v in params.items() 
                       if k not in ['sign', 'apiKey', 'portrait']}
        
        # ç§»é™¤ç©ºå€¼
        sign_params = {k: v for k, v in sign_params.items() 
                       if v is not None and v != ''}
        
        # æŒ‰é”®åæ’åº
        sorted_keys = sorted(sign_params.keys())
        
        # æ‹¼æ¥å‚æ•°å€¼
        string_to_sign = ''.join(str(sign_params[k]) for k in sorted_keys)
        
        # ä¸¤æ¬¡ MD5
        first_md5 = self._md5(string_to_sign)
        return self._md5(first_md5 + self.api_key)
    
    def report_lead(
        self,
        phone: Optional[str] = None,
        wechat_id: Optional[str] = None,
        name: Optional[str] = None,
        source: Optional[str] = None,
        remark: Optional[str] = None,
        tags: Optional[str] = None,
        site_tags: Optional[str] = None,
        portrait: Optional[Portrait] = None
    ) -> Dict[str, Any]:
        """
        ä¸ŠæŠ¥çº¿ç´¢
        
        Args:
            phone: æ‰‹æœºå·
            wechat_id: å¾®ä¿¡å·
            name: å®¢æˆ·å§“å
            source: çº¿ç´¢æ¥æº
            remark: å¤‡æ³¨
            tags: å¾®ä¿¡æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰
            site_tags: ç«™å†…æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰
            portrait: ç”¨æˆ·ç”»åƒ
            
        Returns:
            API å“åº”
        """
        params = {
            'apiKey': self.api_key,
            'timestamp': int(time.time()),
        }
        
        # æ·»åŠ å¯é€‰å‚æ•°
        if phone:
            params['phone'] = phone
        if wechat_id:
            params['wechatId'] = wechat_id
        if name:
            params['name'] = name
        if source:
            params['source'] = source
        if remark:
            params['remark'] = remark
        if tags:
            params['tags'] = tags
        if site_tags:
            params['siteTags'] = site_tags
        if portrait:
            params['portrait'] = asdict(portrait)
        
        # ç”Ÿæˆç­¾å
        params['sign'] = self._generate_sign(params)
        
        # å‘é€è¯·æ±‚
        response = requests.post(
            f"{self.base_url}/v1/api/scenarios",
            json=params,
            headers={'Content-Type': 'application/json'}
        )
        
        return response.json()


# ============ ä½¿ç”¨ç¤ºä¾‹ ============

# åˆå§‹åŒ–å®¢æˆ·ç«¯
ckb = CunKeBaoClient(api_key='YOUR_API_KEY')

# ä¸ŠæŠ¥çº¿ç´¢
result = ckb.report_lead(
    phone='13800000000',
    name='å¼ ä¸‰',
    source='å¾®ä¿¡å¹¿å‘Š',
    tags='é«˜æ„å‘,ç”µå•†'
)

# ä¸ŠæŠ¥å¸¦ç”»åƒçš„çº¿ç´¢
result = ckb.report_lead(
    phone='13800000001',
    name='æå››',
    source='æŠ–éŸ³ç›´æ’­',
    portrait=Portrait(
        type=1,  # ç‚¹å‡»
        sourceData={
            'productId': 'P12345',
            'pageUrl': 'https://example.com/product'
        },
        uniqueId=f'site_13800000001_{int(time.time())}'
    )
)
```

---

## â“ ä¸ƒã€å¸¸è§é—®é¢˜ (FAQ)

### Q1: ç­¾åéªŒè¯å¤±è´¥æ€ä¹ˆæ’æŸ¥ï¼Ÿ

**A**: æŒ‰ä»¥ä¸‹æ­¥éª¤æ’æŸ¥ï¼š
1. ç¡®è®¤ apiKey æ­£ç¡®
2. ç¡®è®¤ timestamp åœ¨ 5 åˆ†é’Ÿå†…
3. ç¡®è®¤ç§»é™¤äº† signã€apiKeyã€portrait å­—æ®µ
4. ç¡®è®¤ç§»é™¤äº†ç©ºå€¼å­—æ®µ
5. ç¡®è®¤æŒ‰é”®åæ’åº
6. ç¡®è®¤ MD5 æ˜¯å°å†™

### Q2: portrait å­—æ®µæ˜¯å¦å¿…ä¼ ï¼Ÿ

**A**: ä¸æ˜¯å¿…ä¼ ã€‚åªæœ‰éœ€è¦è®°å½•ç”¨æˆ·ç”»åƒæ—¶æ‰ä¼ é€’ã€‚

### Q3: uniqueId çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**A**: é˜²æ­¢é‡å¤è®°å½•ã€‚ç›¸åŒ uniqueId çš„ç”»åƒæ•°æ®åœ¨åŠå°æ—¶å†…ä¼šåˆå¹¶ç»Ÿè®¡ã€‚

### Q4: phone å’Œ wechatId å¿…é¡»ä¼ å“ªä¸ªï¼Ÿ

**A**: è‡³å°‘ä¼ ä¸€ä¸ªã€‚wechatId ä¼˜å…ˆä½œä¸ºä¸»æ ‡è¯†ã€‚

### Q5: æ—¶é—´æˆ³è¶…æ—¶æ€ä¹ˆå¤„ç†ï¼Ÿ

**A**: ç¡®ä¿æœåŠ¡å™¨æ—¶é—´å‡†ç¡®ï¼Œæˆ–ä½¿ç”¨ NTP åŒæ­¥æ—¶é—´ã€‚

---

## ğŸ”— å…«ã€ä¸å¼€å‘æ¨¡æ¿è”åŠ¨

### 8.1 åœ¨é¡¹ç›®ä¸­ä½¿ç”¨

```
1. å¤åˆ¶æœ¬æ–‡ä»¶ä¸­çš„å·¥å…·ç±»åˆ°é¡¹ç›® lib/ckb.ts
2. é…ç½® apiKey åˆ°ç¯å¢ƒå˜é‡
3. åœ¨éœ€è¦çš„åœ°æ–¹è°ƒç”¨ ckb.reportLead()
```

### 8.2 è”åŠ¨æŒ‡ä»¤

```
# ç”Ÿæˆå­˜å®¢å®å¯¹æ¥ä»£ç 
@è”åŠ¨ å­˜å®¢å®â†’åç«¯ï¼šç”Ÿæˆçº¿ç´¢ä¸ŠæŠ¥ Service

# ç”Ÿæˆå‰ç«¯è¡¨å•
@è”åŠ¨ å­˜å®¢å®â†’å‰ç«¯ï¼šç”Ÿæˆç•™èµ„è¡¨å•ç»„ä»¶
```

---

## ğŸ“ ä¹ã€æŠ€æœ¯æ”¯æŒ

- **æ¥å£é—®é¢˜**: è”ç³»å­˜å®¢å®æŠ€æœ¯æ”¯æŒ
- **apiKey ç”³è¯·**: è”ç³»å¡è‹¥ï¼ˆå¾®ä¿¡ 28533368ï¼‰

---

> **æ›´æ–°æ—¥å¿—**:
> - v1.0 (2026-01-18): åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒçº¿ç´¢ä¸ŠæŠ¥å’Œç”¨æˆ·ç”»åƒ
