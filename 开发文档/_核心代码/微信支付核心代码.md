# ðŸ’° å¾®ä¿¡æ”¯ä»˜æ ¸å¿ƒä»£ç 

> **æ–‡ä»¶ä½ç½®**: `miniprogram/utils/payment.js`  
> **å¤åˆ»æ¥æº**: Soulåˆ›ä¸šå®žéªŒé¡¹ç›®  
> **æ”¯ä»˜æ–¹å¼**: å¾®ä¿¡å°ç¨‹åºJSAPIæ”¯ä»˜

---

## ä¸€ã€æ”¯ä»˜æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant MP as å°ç¨‹åº
    participant BE as åŽç«¯API
    participant WX as å¾®ä¿¡æ”¯ä»˜

    U->>MP: ç‚¹å‡»è´­ä¹°VIP
    MP->>BE: POST /api/payment/create
    BE->>WX: ç»Ÿä¸€ä¸‹å•
    WX-->>BE: è¿”å›žprepay_id
    BE-->>MP: è¿”å›žæ”¯ä»˜å‚æ•°
    MP->>WX: wx.requestPayment()
    WX->>U: æ‹‰èµ·æ”¯ä»˜ç•Œé¢
    U->>WX: ç¡®è®¤æ”¯ä»˜
    WX-->>MP: æ”¯ä»˜æˆåŠŸå›žè°ƒ
    MP->>BE: POST /api/payment/notify
    BE-->>MP: æ›´æ–°è®¢å•çŠ¶æ€
    MP->>U: æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸ
```

---

## äºŒã€æ ¸å¿ƒä»£ç 

```javascript
// ========================================
// æ–‡ä»¶: miniprogram/utils/payment.js
// ä½œç”¨: å¾®ä¿¡æ”¯ä»˜å·¥å…·ç±»
// æ ¸å¿ƒåŠŸèƒ½:
//   1. å‘èµ·å¾®ä¿¡æ”¯ä»˜
//   2. VIPä¼šå‘˜è´­ä¹°
//   3. æµ‹è¯•æ¬¡æ•°è´­ä¹°
//   4. æƒé™æ£€æŸ¥
// ========================================

const app = getApp()

/**
 * å‘èµ·å¾®ä¿¡æ”¯ä»˜ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
 * @param {Object} options æ”¯ä»˜é€‰é¡¹
 * @param {String} options.orderId è®¢å•ID
 * @param {Number} options.amount é‡‘é¢ï¼ˆåˆ†ï¼‰
 * @param {String} options.description å•†å“æè¿°
 * @param {String} options.productType å•†å“ç±»åž‹
 */
function wxPay(options) {
  const { orderId, amount, description, productType, success, fail } = options
  
  wx.showLoading({ title: 'æ­£åœ¨æ”¯ä»˜...', mask: true })

  // 1. è°ƒç”¨åŽç«¯åˆ›å»ºæ”¯ä»˜è®¢å•
  wx.request({
    url: `${app.globalData.apiBase}/api/payment/create`,
    method: 'POST',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('token')}`,
      'Content-Type': 'application/json'
    },
    data: {
      orderId,
      amount,
      description,
      productType,
      paymentMethod: 'wechat',
      openId: app.globalData.openId || ''
    },
    success: (res) => {
      wx.hideLoading()
      
      if (res.statusCode === 200 && res.data.code === 200) {
        const paymentData = res.data.data
        
        // 2. è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
        wx.requestPayment({
          timeStamp: paymentData.timeStamp,
          nonceStr: paymentData.nonceStr,
          package: paymentData.package,
          signType: paymentData.signType || 'MD5',
          paySign: paymentData.paySign,
          success: (payRes) => {
            // 3. é€šçŸ¥åŽç«¯æ”¯ä»˜æˆåŠŸ
            notifyPaymentSuccess(orderId, paymentData.prepayId)
            wx.showToast({ title: 'æ”¯ä»˜æˆåŠŸ', icon: 'success' })
            success && success(payRes)
          },
          fail: (payErr) => {
            if (payErr.errMsg.indexOf('cancel') !== -1) {
              wx.showToast({ title: 'æ”¯ä»˜å·²å–æ¶ˆ', icon: 'none' })
            } else {
              wx.showToast({ title: 'æ”¯ä»˜å¤±è´¥', icon: 'none' })
            }
            fail && fail(payErr)
          }
        })
      } else {
        wx.showToast({ title: res.data.message || 'åˆ›å»ºè®¢å•å¤±è´¥', icon: 'none' })
        fail && fail(res)
      }
    },
    fail: (err) => {
      wx.hideLoading()
      wx.showToast({ title: 'ç½‘ç»œè¯·æ±‚å¤±è´¥', icon: 'none' })
      fail && fail(err)
    }
  })
}

/**
 * è´­ä¹°VIPä¼šå‘˜
 * @param {String} vipType ä¼šå‘˜ç±»åž‹: month/quarter/year/lifetime
 */
function purchaseVIP(vipType, success, fail) {
  const prices = {
    month: 1990,      // 19.9å…ƒ
    quarter: 4990,    // 49.9å…ƒ
    year: 9900,       // 99å…ƒ
    lifetime: 19900   // 199å…ƒ
  }
  
  const names = {
    month: 'æœˆåº¦VIPä¼šå‘˜',
    quarter: 'å­£åº¦VIPä¼šå‘˜',
    year: 'å¹´åº¦VIPä¼šå‘˜',
    lifetime: 'ç»ˆèº«VIPä¼šå‘˜'
  }
  
  const orderId = `VIP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  
  wxPay({
    orderId,
    amount: prices[vipType],
    description: `MBTIæ€§æ ¼æµ‹è¯• - ${names[vipType]}`,
    productType: 'vip',
    success: (res) => {
      updateVIPStatus(vipType)  // æ›´æ–°æœ¬åœ°VIPçŠ¶æ€
      success && success(res)
    },
    fail
  })
}

/**
 * è´­ä¹°æµ‹è¯•æ¬¡æ•°
 * @param {Number} count è´­ä¹°æ¬¡æ•°
 */
function purchaseTestCount(count, success, fail) {
  // é˜¶æ¢¯å®šä»·: 1æ¬¡=3.9å…ƒ, 10æ¬¡=29å…ƒ, 50æ¬¡=99å…ƒ
  let price = count * 390
  if (count >= 10) price = Math.floor(count * 290)
  if (count >= 50) price = Math.floor(count * 198)
  
  const orderId = `TEST_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  
  wxPay({
    orderId,
    amount: price,
    description: `MBTIæ€§æ ¼æµ‹è¯• - ${count}æ¬¡æµ‹è¯•æ¬¡æ•°`,
    productType: 'test_count',
    success: (res) => {
      addTestCount(count)  // å¢žåŠ æœ¬åœ°æµ‹è¯•æ¬¡æ•°
      success && success(res)
    },
    fail
  })
}

/**
 * æ£€æŸ¥æ˜¯å¦æ˜¯VIP
 * @returns {Boolean}
 */
function checkVIP() {
  const vipInfo = wx.getStorageSync('vipInfo')
  if (!vipInfo || !vipInfo.isVIP) return false
  
  const expireDate = new Date(vipInfo.expireDate)
  return expireDate > new Date()
}

/**
 * æ£€æŸ¥æµ‹è¯•æƒé™
 * @param {String} testType æµ‹è¯•ç±»åž‹
 * @returns {Boolean}
 */
function canTakeTest(testType) {
  // VIPç”¨æˆ·å¯æ— é™æµ‹è¯•
  if (checkVIP()) return true
  
  // æ£€æŸ¥æ˜¯å¦å·²è§£é”è¯¥æµ‹è¯•
  const unlockedTests = wx.getStorageSync('unlockedTests') || []
  if (unlockedTests.includes(testType)) return true
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æµ‹è¯•æ¬¡æ•°
  const testCount = wx.getStorageSync('testCount') || 0
  return testCount > 0
}

/**
 * æ¶ˆè€—ä¸€æ¬¡æµ‹è¯•æ¬¡æ•°
 * @returns {Boolean} æ˜¯å¦æˆåŠŸæ¶ˆè€—
 */
function consumeTestCount() {
  const testCount = wx.getStorageSync('testCount') || 0
  if (testCount > 0) {
    wx.setStorageSync('testCount', testCount - 1)
    app.globalData.testCount = testCount - 1
    return true
  }
  return false
}

// å¯¼å‡ºæ‰€æœ‰å‡½æ•°
module.exports = {
  wxPay,
  purchaseVIP,
  purchaseTestCount,
  purchaseSingleTest,
  checkVIP,
  canTakeTest,
  consumeTestCount,
  getUserBenefits
}
```

---

## ä¸‰ã€å®šä»·ç­–ç•¥

### 3.1 VIPä¼šå‘˜

| å¥—é¤ | ä»·æ ¼ | æœ‰æ•ˆæœŸ | å•æ—¥æˆæœ¬ |
|:---|:---:|:---:|:---:|
| æœˆåº¦ä¼šå‘˜ | Â¥19.9 | 30å¤© | Â¥0.66 |
| å­£åº¦ä¼šå‘˜ | Â¥49.9 | 90å¤© | Â¥0.55 |
| å¹´åº¦ä¼šå‘˜ | Â¥99 | 365å¤© | Â¥0.27 |
| ç»ˆèº«ä¼šå‘˜ | Â¥199 | æ°¸ä¹… | - |

### 3.2 æµ‹è¯•æ¬¡æ•°

| æ•°é‡ | ä»·æ ¼ | å•æ¬¡æˆæœ¬ |
|:---:|:---:|:---:|
| 1æ¬¡ | Â¥3.9 | Â¥3.9 |
| 10æ¬¡ | Â¥29 | Â¥2.9 |
| 50æ¬¡ | Â¥99 | Â¥1.98 |

### 3.3 å•æ¬¡è§£é”

| æµ‹è¯• | ä»·æ ¼ |
|:---|:---:|
| MBTIæµ‹è¯• | Â¥9.9 |
| DISCæµ‹è¯• | Â¥6.9 |
| PDPæµ‹è¯• | Â¥6.9 |
| AIäººè„¸åˆ†æž | Â¥19.9 |

---

## å››ã€åŽç«¯æŽ¥å£è¦æ±‚

### 4.1 åˆ›å»ºè®¢å•æŽ¥å£

```typescript
// POST /api/payment/create
// è¯·æ±‚
{
  orderId: "VIP_1706428800000_abc123",
  amount: 1990,  // åˆ†
  description: "MBTIæ€§æ ¼æµ‹è¯• - æœˆåº¦VIPä¼šå‘˜",
  productType: "vip",
  paymentMethod: "wechat",
  openId: "oXXXX_xxxxx"
}

// å“åº”
{
  code: 200,
  data: {
    timeStamp: "1706428800",
    nonceStr: "5K8264ILTKCH16CQ2502SI8ZNMTM67VS",
    package: "prepay_id=wx201410272009395522657a690389285100",
    signType: "MD5",
    paySign: "22D9XXXXXXXXXXXXXXXXXXXXXXXX"
  }
}
```

### 4.2 å¾®ä¿¡æ”¯ä»˜å•†æˆ·é…ç½®

```yaml
# ä½¿ç”¨å¡è‹¥çŽ°æœ‰é…ç½®
AppID: wx3d15ed02e98b04e3
å•†æˆ·å·: 1318592501
APIå¯†é’¥: wx3e31b068be59ddc131b068be59ddc2
```

---

## äº”ã€æµ‹è¯•é¡µé¢ä¸­ä½¿ç”¨æ”¯ä»˜

```javascript
// pages/test/mbti.js
const payment = require('../../utils/payment')

Page({
  onLoad() {
    // æ£€æŸ¥æ˜¯å¦æœ‰æƒé™æµ‹è¯•
    if (!this.checkAccess()) {
      return
    }
    // ... åˆå§‹åŒ–æµ‹è¯•
  },

  checkAccess() {
    const canTest = payment.canTakeTest('mbti')
    
    if (!canTest) {
      wx.showModal({
        title: 'éœ€è¦è´­ä¹°',
        content: 'æ‚¨æš‚æ— æµ‹è¯•æƒé™ï¼Œæ˜¯å¦å‰å¾€è´­ä¹°ï¼Ÿ',
        confirmText: 'åŽ»è´­ä¹°',
        success: (res) => {
          if (res.confirm) {
            wx.navigateTo({ url: '/pages/purchase/index' })
          } else {
            wx.navigateBack()
          }
        }
      })
      return false
    }
    
    // æ¶ˆè€—æµ‹è¯•æ¬¡æ•°
    const benefits = payment.getUserBenefits()
    if (!benefits.isVIP && !benefits.unlockedTests.includes('mbti')) {
      payment.consumeTestCount()
    }
    
    return true
  }
})
```
